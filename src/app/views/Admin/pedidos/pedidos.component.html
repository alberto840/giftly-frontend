<div class="p-[60px] flex flex-col justify-center items-center w-full bg-primary">
    <div class="w-full mb-3 flex items-center gap-1">
        <div class="text-5xl text-white font-bold">Gestión de Pedidos</div>
        <p-menu #menu [model]="items" [popup]="true" />
        <p-button (click)="menu.toggle($event)" icon="pi pi-spin pi-cog" [rounded]="true" [outlined]="true"
            severity="primary" [outlined]="true" />
    </div>
    <div class="card">
        <p-toast></p-toast>
        <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

        <div class="flex justify-end mb-4">
            <p-button label="Crear Pedido" icon="pi pi-plus" class="p-button-success"
                (onClick)="openNew()"></p-button>
        </div>

        <p-table class="w-full" #dt [value]="pedidos" [rows]="10" [paginator]="true" [globalFilterFields]="['id']"
            [tableStyle]="{'min-width': '75rem'}" [rowHover]="true" dataKey="id"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} entradas"
            [showCurrentPageReport]="true">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="id" style="min-width:5rem">ID <p-sortIcon field="id"></p-sortIcon></th>
                    <th pSortableColumn="fechaCreacion" style="min-width:10rem">Creación <p-sortIcon field="fechaCreacion"></p-sortIcon></th>
                    <th pSortableColumn="fechaEnvio" style="min-width:10rem">Envío <p-sortIcon field="fechaEnvio"></p-sortIcon></th>
                    <th pSortableColumn="total" style="min-width:10rem">Total <p-sortIcon field="total"></p-sortIcon></th>
                    <th pSortableColumn="usuarioId" style="min-width:8rem">Usuario ID <p-sortIcon field="usuarioId"></p-sortIcon></th>
                    <th pSortableColumn="status" style="min-width:8rem">Status <p-sortIcon field="status"></p-sortIcon></th>
                    <th style="min-width:5rem">Detalle</th>
                    <th style="min-width:5rem">Productos</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-pedido>
                <tr>
                    <td>{{pedido.pedido.id}}</td>
                    <td>{{pedido.pedido.fechaCreacion | date:'dd/MM/yyyy'}}</td>
                    <td>{{pedido.pedido.fechaEnvio | date:'dd/MM/yyyy'}}</td>
                    <td>{{pedido.pedido.total | currency}}</td>
                    <td>{{pedido.pedido.usuarioId}}</td>
                    <td>{{pedido.pedido.status}}</td>
                    <td>
                        <p-button icon="pi pi-info-circle" [rounded]="true" severity="info" 
                                (onClick)="verDetalle(pedido)"></p-button>
                    </td>
                    <td>
                        <p-button icon="pi pi-box" [rounded]="true" severity="help" 
                                (onClick)="verProductos(pedido)"></p-button>
                    </td>
                    <td>
                        <p-button icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2"
                            (onClick)="editPedido(pedido)"></p-button>
                        <p-button icon="pi pi-trash" class="p-button-rounded p-button-warning"
                            (onClick)="deletePedido(pedido)"></p-button>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <p-dialog [(visible)]="pedidoDialog" [style]="{width: '450px'}" header="Detalles de Pedido" [modal]="true"
            styleClass="p-fluid">
            <ng-template pTemplate="content">
                <form [formGroup]="form">
                    <div class="field mb-3">
                        <label for="fechaCreacion">Fecha Creación</label>
                        <p-calendar id="fechaCreacion" formControlName="fechaCreacion" [showIcon]="true" dateFormat="yy-mm-dd" dataType="string"></p-calendar>
                        <small class="p-error" *ngIf="submitted && f['fechaCreacion'].errors?.['required']">Fecha creación requerida.</small>
                    </div>
                    <div class="field mb-3">
                        <label for="fechaEnvio">Fecha Envío</label>
                        <p-calendar id="fechaEnvio" formControlName="fechaEnvio" [showIcon]="true" dateFormat="yy-mm-dd" dataType="string"></p-calendar>
                        <small class="p-error" *ngIf="submitted && f['fechaEnvio'].errors?.['required']">Fecha envío requerida.</small>
                    </div>
                    <div class="field mb-3">
                        <label for="total">Total</label>
                        <p-inputNumber id="total" formControlName="total" mode="currency" currency="USD" locale="en-US"></p-inputNumber>
                        <small class="p-error" *ngIf="submitted && f['total'].errors?.['required']">Total requerido.</small>
                    </div>
                    <div class="field mb-3">
                        <label for="qrId">QR ID</label>
                        <p-inputNumber id="qrId" formControlName="qrId" [useGrouping]="false"></p-inputNumber>
                        <small class="p-error" *ngIf="submitted && f['qrId'].errors?.['required']">QR ID requerido.</small>
                    </div>
                    <div class="field mb-3">
                        <label for="usuarioId">Usuario ID</label>
                        <p-inputNumber id="usuarioId" formControlName="usuarioId" [useGrouping]="false"></p-inputNumber>
                        <small class="p-error" *ngIf="submitted && f['usuarioId'].errors?.['required']">Usuario ID requerido.</small>
                    </div>
                    <div class="field mb-3">
                        <label for="tiendaPremioId">Tienda Premio ID</label>
                        <p-inputNumber id="tiendaPremioId" formControlName="tiendaPremioId" [useGrouping]="false"></p-inputNumber>
                        <small class="p-error" *ngIf="submitted && f['tiendaPremioId'].errors?.['required']">Tienda Premio ID requerido.</small>
                    </div>
                    <div class="field mb-3">
                        <label for="status">Status</label>
                        <input id="status" type="text" pInputText formControlName="status" />
                        <small class="p-error" *ngIf="submitted && f['status'].errors?.['required']">Status requerido.</small>
                    </div>
                </form>
            </ng-template>

            <ng-template pTemplate="footer">
                <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
                    (click)="hideDialog()"></button>
                <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text"
                    (click)="savePedido()"></button>
            </ng-template>
        </p-dialog>

        <p-dialog [(visible)]="deletePedidoDialog" header="Confirmar" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span *ngIf="pedido">¿Estás seguro de que quieres eliminar el pedido <b>{{pedido.id}}</b>?</span>
            </div>
            <ng-template pTemplate="footer">
                <button pButton pRipple icon="pi pi-times" class="p-button-text" label="No"
                    (click)="deletePedidoDialog = false"></button>
                <button pButton pRipple icon="pi pi-check" class="p-button-text" label="Sí"
                    (click)="confirmDelete()"></button>
            </ng-template>
        </p-dialog>
    </div>
</div>

<p-dialog [(visible)]="detalleDialog" [style]="{width: '500px'}" header="Detalles de Entrega" [modal]="true">
    <div *ngIf="cargandoDetalle" class="flex justify-center p-4">
        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
    </div>

    <div class="grid" *ngIf="detalleSeleccionado && !cargandoDetalle">
        <div class="col-12 border-bottom-1 surface-border mb-3">
            <h3 class="m-0 text-primary">Información del Receptor</h3>
        </div>
        <div class="col-12 mb-2"><strong>Receptor:</strong> {{detalleSeleccionado.receptorEncarga}}</div>
        <div class="col-12 mb-2"><strong>Para:</strong> {{detalleSeleccionado.nombreObjetivo}}</div>
        <div class="col-6 mb-2"><strong>Celular 1:</strong> {{detalleSeleccionado.celular1}}</div>
        <div class="col-6 mb-2"><strong>Celular 2:</strong> {{detalleSeleccionado.celular2}}</div>
        
        <div class="col-12 mt-3 border-bottom-1 surface-border mb-3" *ngIf="ubicacionDetalle">
            <h3 class="m-0 text-primary">Ubicación Seleccionada</h3>
        </div>
        <div class="col-12" *ngIf="ubicacionDetalle">
            <p><strong>Detalle:</strong> {{ubicacionDetalle.detalle}}</p>
        </div>
        <div class="col-12 mt-2">
            <div id="map-detail" style="height: 300px; width: 100%; border-radius: 12px; border: 1px solid #ddd; z-index: 1;"></div>
        </div>
    </div>
</p-dialog>

<p-dialog [(visible)]="productosDialog" [style]="{width: '700px'}" header="Lista de Productos" [modal]="true">
    <p-table [value]="productosSeleccionados" [loading]="cargandoProductos" responsiveLayout="scroll">
        <ng-template pTemplate="header">
            <tr>
                <th>Imagen</th>
                <th>Producto</th>
                <th>Precio Unit.</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-prod>
            <tr>
                <td>
                    <img [src]="'.//public/products/' + prod.imagenUrl" [alt]="prod.nombre" width="50" class="shadow-2" />
                </td>
                <td>{{prod.nombre}}</td>
                <td>{{prod.precio | currency}}</td>
                <td>
                    <span class="p-badge p-badge-info">{{prod.cantidad}}</span>
                </td>
                <td><strong>{{(prod.precio * prod.cantidad) | currency}}</strong></td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5" class="text-center p-4">No hay productos registrados.</td>
            </tr>
        </ng-template>
    </p-table>
</p-dialog>
